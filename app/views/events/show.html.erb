<h1><%= @event.name %></h1>
<div class='register'>
  <div class='user-event'>
    <% if @user_registration_id == 0 %>
      <%= link_to t(:'register.individual'), '#', class: 'btn btn-primary user-register-event' %>
    <% else %>
      <%= link_to t(:'unregister.individual'), '#', class: 'btn btn-warning user-unregister-event', data: {id: @user_registration_id} %>
    <% end %>
  </div>

  <!-- FIXME: get that register/unregister logic done! -->
  <div class='project-event'>
    <% if @project_registration_id == 0 %>
      <%= link_to t(:'register.project'), '#', class: 'btn btn-success project-register-event' %>
    <% else %>
      <%= link_to t(:'unregister.project'), '#', class: 'btn btn-warning project-unregister-event', data:{id: @project_registration_id} %>
    <% end %>
  </div>

  <div id='select-project-form'>
    <%= select_tag 'Projects', options_from_collection_for_select(current_user.projects, 'id', 'title'), id: 'project-event-select' %>
    <%= link_to t(:'register.choose_project'), '#', class: 'btn btn-primary project-register-event-final' %>
  </div>

</div>

<!-- FIXME: hella messy, need to clean up!!!! -->
<div style='width: 100%;'>
  <div id="map" style='width: 100%; height: 400px;'></div>
</div>


<div class='event-project-registrants'>
  <% @event.projects.each do |project| %>
    <%= project.title %>
    <% if !current_user.has_voted_for?(project, @event) %>
      <a class='btn btn-info vote'>Vote for This Project</a>
    <% else %>
      <a class='btn btn-info unvote'>Unvote for This Project</a>
    <% end %>
  <% end %>
</div>

<script src="//maps.google.com/maps/api/js?v=3.13&amp;sensor=false&amp;libraries=geometry" type="text/javascript"></script>
<script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js' type='text/javascript'></script>

<script type='text/javascript'>
    //FIXME: this should be a backbone view, but later!!!
    $(document).ready(function (){
        // User Register for Event
        $('div.register').on('click', '.user-register-event', function(event) {
            event.preventDefault();
            $.ajax({
                url: '/user_event_registrations',
                type: 'POST',
                data: {user_event_registration: {user_id: <%= current_user.id %>, event_id: <%= @event.id %>}},
                dataType: 'json',
                success: function(data) {
                    $('.user-register-event').remove();
                    var unRegister = $("<a href='#' class='btn btn-warning user-unregister-event' data-remote='true' data-id=" + data.id + ">Unregister Event</a>");
                    $('.register').prepend(unRegister);

                }
            });
        });
        // User Unregister for Event
        $('div.register').on('click', '.user-unregister-event', function(event) {
            event.preventDefault();
            var regId = $(this).attr('data-id');
            $.ajax({
                url: '/user_event_registrations/' + regId,
                type: 'DELETE',
                dataType: 'json',
                success: function(data, event) {
                    $('.user-unregister-event').remove();
                    var register = $("<a href='#' class='btn btn-primary user-register-event'>Register as an Individual</a>");
                    $('.register').prepend(register);
                }
            });
        });
        // Show select project form
        $('div.register').on('click', '.project-register-event', function(event) {
            event.preventDefault();
            $('#select-project-form').show();
        });
        // Project register for event
        $('div.register').on('click', '.project-register-event-final', function(event) {
            event.preventDefault();
            var projectId = $('#project-event-select option:selected').val();
            $.ajax({
                url: '/project_event_registrations',
                type: 'POST',
                data: {project_event_registration: {project_id: projectId, event_id: <%= @event.id %>}},
                dataType: 'json',
                success: function(data) {
                    $('.project-register-event').remove();
                    $('#select-project-form').hide();
                    $('div.project-event').append("<a href='#' class='btn btn-warning project-unregister-event' data-id=" + data.id + ">Unregister Event</a>");
                }
            });
        });
        // Project unregister for event
        $('div.register').on('click', '.project-unregister-event', function(event) {
            event.preventDefault();
            var regId = $(this).attr('data-id');
            $.ajax({
                url: '/project_event_registrations/' + regId,
                type: 'DELETE',
                dataType: 'json',
                success: function(data) {
                    $('div.project-event').append("<a href='#' class='btn btn-success project-register-event'>Register for Your Startup</a>");
                    $('.project-unregister-event').remove();
                }
            });
        });

        // Google Maps 
        handler = Gmaps.build('Google');
        handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
          markers = handler.addMarkers([
            {
              "lat": 0,
              "lng": 0,
              "picture": {
                "url": "https://addons.cdn.mozilla.net/img/uploads/addon_icons/13/13028-64.png",
                "width":  36,
                "height": 36
              },
              "infowindow": "hello!"
            }
          ]);
          handler.bounds.extendWith(markers);
          handler.fitMapToBounds();
        });
    });
</script>
