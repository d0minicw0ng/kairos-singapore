<div class='container'>
  <h1 class='pull-left'><%= @event.name %></h1>
  <div class='register pull-right'>
    <div class='row user-project-register'>
      <div class='user-event col-md-5'>
        <% if @user_registration_id == 0 %>
          <%= link_to t(:'register.individual'), '#', class: 'btn btn-primary user-register-event' %>
        <% else %>
          <%= link_to t(:'unregister.individual'), '#', class: 'btn btn-warning user-unregister-event', data: {id: @user_registration_id} %>
        <% end %>
      </div>

      <div class='project-event col-md-5'>
        <% if @project_registration_id == 0 %>
          <%= link_to t(:'register.project'), '#', class: 'btn btn-success project-register-event' %>
        <% else %>
          <%= link_to t(:'unregister.project'), '#', class: 'btn btn-warning project-unregister-event', data:{id: @project_registration_id} %>
        <% end %>
      </div>
      <br />
    </div>
    <div class='row'>
      <div id='select-project-form'>
        <%= select_tag 'Projects', options_from_collection_for_select(current_user.projects, 'id', 'title'), id: 'project-event-select' %>
        <%= link_to t(:'register.choose_project'), '#', class: 'btn btn-primary project-register-event-final' %>
      </div>
    </div>
  </div>

  <div style='width: 100%;'>
    <div id="map" style='width: 100%; height: 400px;'></div>
  </div>

  <% if @event.projects.length > 0 %>
    <h3><%= t(:'register.event_registrants') %></h3>
    <ul class='event-project-registrants'>
      <% @event.projects.each do |project| %>
        <li class='project-registrant' id='project-"<%= project.id %>"'>
          <%= link_to project.title, project_url(project) %>
          <% if !current_user.has_voted_for?(project, @event) %>
            <a class='btn btn-info vote' data-event-id="<%= @event.id %>" data-project-id="<%= project.id %>">Vote for This Project</a>
          <% else %>
            <a class='btn btn-info unvote' data-event-id="<%= @event.id %>" data-project-id="<%= project.id %>">Unvote for This Project</a>
          <% end %>
        </li>
      <% end %>
    </ul>
  <% end %>

  <%= render partial: 'comments/comments', object: @event.comments %>
  <%= render partial: 'comments/new', locals: { parent: @event } %>
</div>

<script src="//maps.google.com/maps/api/js?v=3.13&amp;sensor=false&amp;libraries=geometry" type="text/javascript"></script>
<script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js' type='text/javascript'></script>

<script type='text/javascript'>
    //FIXME: this should be a backbone view, but later!!!
    $(document).ready(function (){
        // User Register for Event
        $('div.register').on('click', '.user-register-event', function(event) {
            event.preventDefault();
            $.ajax({
                url: '/user_event_registrations',
                type: 'POST',
                data: {user_event_registration: {user_id: <%= current_user.id %>, event_id: <%= @event.id %>}},
                dataType: 'json',
                success: function(data) {
                    $('.user-register-event').remove();
                    var unRegister = $("<a href='#' class='btn btn-warning user-unregister-event' data-remote='true' data-id=" + data.id + ">Unregister Event</a>");
                    $('.user-event').prepend(unRegister);

                }
            });
        });
        // User Unregister for Event
        $('div.register').on('click', '.user-unregister-event', function(event) {
            event.preventDefault();
            var regId = $(this).attr('data-id');
            $.ajax({
                url: '/user_event_registrations/' + regId,
                type: 'DELETE',
                dataType: 'json',
                success: function(data, event) {
                    $('.user-unregister-event').remove();
                    var register = $("<a href='#' class='btn btn-primary user-register-event'>Register as an Individual</a>");
                    $('.user-event').prepend(register);
                }
            });
        });
        // Show select project form
        $('div.register').on('click', '.project-register-event', function(event) {
            event.preventDefault();
            $('#select-project-form').show();
        });
        // Project register for event
        $('div.register').on('click', '.project-register-event-final', function(event) {
            event.preventDefault();
            var projectId = $('#project-event-select option:selected').val();
            $.ajax({
                url: '/project_event_registrations',
                type: 'POST',
                data: {project_event_registration: {project_id: projectId, event_id: <%= @event.id %>}},
                dataType: 'json',
                success: function(data) {
                    $('.project-register-event').remove();
                    $('#select-project-form').hide();
                    $('.project-event').append("<a href='#' class='btn btn-warning project-unregister-event' data-id=" + data.id + ">Unregister Event</a>");
                }
            });
        });
        // Project unregister for event
        $('div.register').on('click', '.project-unregister-event', function(event) {
            event.preventDefault();
            var regId = $(this).attr('data-id');
            $.ajax({
                url: '/project_event_registrations/' + regId,
                type: 'DELETE',
                dataType: 'json',
                success: function(data) {
                    $('.project-event').append("<a href='#' class='btn btn-success project-register-event'>Register for Your Startup</a>");
                    $('.project-unregister-event').remove();
                }
            });
        });

        $('.project-registrant').on('click', '.vote', function(event) {
            var that = this;
            event.preventDefault();
            var eventId = $(that).attr('data-event-id');
            var projectId = $(that).attr('data-project-id');

            $.ajax({
                url: '/votes',
                type: 'POST',
                data: { vote: {project_id: projectId, event_id: eventId, user_id: <%= current_user.id %> }},
                dataType: 'json',
                success: function(data) {
                    $(that).after('<a class="btn btn-info unvote" data-project-id="' + projectId + '" data-event-id="' + eventId +'">Unvote for This Project</a>');
                    $(that).remove();
                }
            });
        });

        $('.project-registrant').on('click', '.unvote', function(event) {
            var that = this;
            event.preventDefault();
            var eventId = $(that).attr('data-event-id');
            var projectId = $(that).attr('data-project-id');

            $.ajax({
                //FIXME: I know this is cheating the routes and controller, but it's the fastest way for now
                url: '/votes/' + 0,
                type: 'DELETE',
                data: { vote: {project_id: projectId, event_id: eventId, user_id: <%= current_user.id %>}},
                dataType: 'json',
                success: function(data) {
                    $(that).after('<a class="btn btn-info vote" data-project-id="' + projectId + '" data-event-id="' + eventId +'">Vote for This Project</a>');
                    $(that).remove();
                }
            });
        });

        // Google Maps 
        handler = Gmaps.build('Google');
        handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
          markers = handler.addMarkers([
            {
              "lat": <%= @event.latitude %>,
              "lng": <%= @event.longitude %>,
              "picture": {
                "url": "https://addons.cdn.mozilla.net/img/uploads/addon_icons/13/13028-64.png",
                "width":  36,
                "height": 36
              },
              "infowindow":'hello'
            }
          ]);
          handler.bounds.extendWith(markers);
          handler.fitMapToBounds();
        });
    });
</script>
